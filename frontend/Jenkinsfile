pipeline {
  agent any

  environment {
    // Git ë¸Œëœì¹˜ì— ë”°ë¼ íƒœê·¸ë§Œ êµ¬ë¶„ (ì˜ˆ: 12-blue)
    BUILD_TAG = "${BUILD_NUMBER}-fe"
    BLUE_IP   = '172.31.55.206'
  }

  tools {                                           // Jenkins â†’ Global ToolÂ Config
    nodejs 'node20'                                 // NodeÂ 20.x LTS ì´ë¦„
  }

  stages {

    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Install & Build') {
      steps {
        sh '''
          echo "ğŸ”§  Installing depsâ€¦"
          npm ci --legacy-peer-deps        # yarn ì´ë‚˜ pnpm ì“°ë©´ êµì²´
          npm run build                    # ê²°ê³¼ë¬¼: dist/  or build/
        '''
      }
    }

    stage('Deploy to Blue') {
      steps {
        sshagent(credentials: ['blue-ec2-ssh']) {   // ì´ë¯¸ ë“±ë¡í•œ EC2 SSH í‚¤
          sh """
            echo 'ğŸš€  Rsync to Blueâ€¦'
            rsync -avz --delete dist/ ec2-user@${BLUE_IP}:/var/www/blue/

            echo 'ğŸ”„  Point current â†’ blue'
            ssh ec2-user@${BLUE_IP} 'ln -sfn /var/www/blue /var/www/current && sudo nginx -s reload'
          """
        }
      }
    }
  }

  post {
    success { echo "âœ…  FE build ${BUILD_TAG} ë°°í¬ ì™„ë£Œ (â†’ Blue)" }
    failure { echo "âŒ  FE build ì‹¤íŒ¨ â€“ ì½˜ì†” ë¡œê·¸ í™•ì¸" }
  }
}
