pipeline {
  agent any

  environment {
    // Git ë¸Œëœì¹˜ì— ë”°ë¼ íƒœê·¸ë§Œ êµ¬ë¶„ (ì˜ˆ: 12â€‘fe)
    BUILD_TAG = "${BUILD_NUMBER}-fe"
    BLUE_IP   = '172.31.55.206'          // ë°°í¬ ëŒ€ìƒ EC2 (Nginx)
    DIST_DIR  = 'frontend/dist'          // ë¹Œë“œ ì‚°ì¶œë¬¼ ìœ„ì¹˜
  }

  tools {                                // Jenkins â†’ Global Tool Configuration
    nodejs 'node20'                      // Node 20.x LTS (ì´ë¯¸ ë“±ë¡í•œ ì´ë¦„)
  }

  stages {

    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Install & Build') {           // **frontend í´ë”ë¡œ ë“¤ì–´ê°€ì„œ ë¹Œë“œ**
      steps {
        dir('frontend') {
          sh '''
            echo "ğŸ”§  Installing depsâ€¦"
            npm ci --legacy-peer-deps

            echo "ğŸ“¦  Buildingâ€¦"
            npm run build
          '''
        }
      }
    }

    stage('Deploy to Blue') {
      steps {
        sshagent(credentials: ['blue-ec2-ssh']) {   // ë“±ë¡í•´ë‘” Blue EC2 SSH í‚¤
          sh """
            echo 'ğŸš€  Rsync to Blueâ€¦'
            rsync -avz --delete ${DIST_DIR}/ ec2-user@${BLUE_IP}:/var/www/blue/

            echo 'ğŸ”„  Switch current â†’ blue'
            ssh -o StrictHostKeyChecking=no ec2-user@${BLUE_IP} '
              ln -sfn /var/www/blue /var/www/current &&
              sudo nginx -s reload
            '
          """
        }
      }
    }
  }

  post {
    success { echo "âœ…  FE build ${BUILD_TAG} ë°°í¬ ì™„ë£Œ (â†’ Blue)" }
    failure { echo "âŒ  FE build ì‹¤íŒ¨ â€“ ì½˜ì†” ë¡œê·¸ í™•ì¸" }
  }
}
