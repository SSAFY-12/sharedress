pipeline {
  agent any

  environment {
    // Git ë¸Œëœì¹˜ì— ë”°ë¼ íƒœê·¸ë§Œ êµ¬ë¶„ (ì˜ˆ: 12-fe)
    BUILD_TAG = "${BUILD_NUMBER}-fe"
    BLUE_IP   = '172.31.35.103'      // LB EC2 í”„ë¼ì´ë¹—(ë˜ëŠ” í¼ë¸”ë¦­) IP
    DIST_DIR  = 'frontend/dist'      // ğŸ”„ dev-dist ë¡œ ë³€ê²½ ê°€ëŠ¥
    SSH_USER  = 'ec2-user'
  }

  tools {                            // Jenkins â†’ Global Tool Configuration
    nodejs 'node20'                  // Node 20.x LTS (ì´ë¯¸ ë“±ë¡í•œ ì´ë¦„)
  }

  stages {

    stage('Checkout') {
      steps { checkout scm }
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       â˜… ì¶”ê°€ â¶ : .env.production ì£¼ì…
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    stage('Inject env') {            // (Managed files â†’ fe-env-production)
      steps {
        configFileProvider([
          configFile(
            fileId: 'fe-env-production',        // Jenkins Managed File ID
            targetLocation: 'frontend/.env.production'
          )
        ]) {
          echo 'âœ…  .env.production ì£¼ì… ì™„ë£Œ'
        }
      }
    }

    stage('Install & Build') {       // **frontend í´ë”ë¡œ ë“¤ì–´ê°€ì„œ ë¹Œë“œ**
      steps {
        dir('frontend') {
          sh '''
            echo "ğŸ”§  Installing depsâ€¦"
            npm ci --legacy-peer-deps

            echo "ğŸ“¦  Buildingâ€¦"
            # Vite ëŠ” .env.production ì„ ìë™ìœ¼ë¡œ ì½ì–´ ì¸ë¼ì¸
            npm run build -- --mode production      # â˜… ì¶”ê°€ â·
          '''
        }
      }
    }

    stage('Deploy to Blue') {
      steps {
        sshagent(credentials: ['lb-ssh']) {   // ë“±ë¡í•´ë‘” Blue EC2 SSH í‚¤
          sh """
            echo 'ğŸš€  Rsync to Blueâ€¦'
            rsync -avz --delete -e "ssh -o StrictHostKeyChecking=no" \
                  ${DIST_DIR}/ ec2-user@${BLUE_IP}:/var/www/blue/

            echo 'ğŸ”„  Switch current â†’ blue'
            ssh -o StrictHostKeyChecking=no ${SSH_USER}@${BLUE_IP} '
              sudo mkdir -p /var/www/current &&
              sudo ln -sfn /var/www/blue /var/www/current &&
              sudo chown -R ${SSH_USER}:${SSH_USER} /var/www &&
              sudo nginx -s reload
            '
          """
        }
      }
    }
  }

  post {
    success { echo "âœ…  FE build ${BUILD_TAG} ë°°í¬ ì™„ë£Œ (â†’ Blue)" }
    failure { echo "âŒ  FE build ì‹¤íŒ¨ â€“ ì½˜ì†” ë¡œê·¸ í™•ì¸" }
  }
}
