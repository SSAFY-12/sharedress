pipeline {
  agent any

  environment {
    AWS_REGION      = 'ap-northeast-2'
    ACCOUNT_ID      = '273354621375'
    ECR_URI         = "${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
    APP_NAME        = 'spring-app'

    BLUE_IP         = '172.31.55.206'   // Blue EC2 (AmazonÂ Linux)
    GREEN_IP        = '172.26.11.74'    // Green EC2 (Ubuntu)
    LB_IP           = '172.31.35.103'   // Nginx LB EC2

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì„ì‹œë¡œ Green ë¹„í™œì„±í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       â–º í”¼ì–´ë§ ì™„ë£Œë˜ë©´ false ë¡œë§Œ ë°”ê¾¸ë©´ ë©ë‹ˆë‹¤          */
    GREEN_DISABLED  = 'true'
  }

  stages {

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì†ŒìŠ¤ ì²´í¬ì•„ì›ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    stage('Checkout') {
      steps { checkout scm }
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë³€ìˆ˜ ê³„ì‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    stage('Prepare Variables') {
      steps {
        script {
          def isGreenBranch = (env.BRANCH_NAME == 'develop-be')
          def color         = isGreenBranch ? 'green' : 'blue'
          env.TAG           = "${env.BUILD_NUMBER}-${color}"

          echo "ğŸ“¦  Branch=${env.BRANCH_NAME}, DeployColor=${color}, TAG=${env.TAG}"
        }
      }
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ JAR ë¹Œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    stage('Build JAR') {
      steps {
        dir('backend') {
          sh '''
            chmod +x gradlew
            ./gradlew clean bootJar
          '''
        }
      }
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Buildx ì¤€ë¹„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    stage('Setup Buildx') {
      steps {
        sh '''
          docker buildx create --name multi-builder --driver docker-container --use || true
          docker buildx inspect multi-builder --bootstrap
        '''
      }
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì´ë¯¸ì§€ ë¹Œë“œ &Â í‘¸ì‹œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    stage('Build & Push Image') {
      steps {
        dir('backend') {
          withCredentials([[
            $class: 'AmazonWebServicesCredentialsBinding',
            credentialsId: 'aws key'
          ]]) {
            sh """
              aws ecr get-login-password --region $AWS_REGION | \
                docker login --username AWS --password-stdin $ECR_URI

              docker buildx build \
                --platform linux/amd64,linux/arm64 \
                --provenance=false \
                -t $ECR_URI/$APP_NAME:\$TAG \
                --push .
            """
          }
        }
      }
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ëŒ€ìƒ ì„œë²„ ë°°í¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    stage('Deploy to Target') {
      steps {
        script {
          boolean greenOff      = (env.GREEN_DISABLED == 'true')
          boolean isGreenBranch = (env.BRANCH_NAME == 'develop-be')

          // â–¸ Green ì´ êº¼ì ¸ìˆìœ¼ë©´ developâ€‘be ë„ Blue ë¡œ ë³´ëƒ„
          def targetIP    = (!greenOff && isGreenBranch) ? env.GREEN_IP : env.BLUE_IP
          def sshCred     = (!greenOff && isGreenBranch) ? 'green-ssh'  : 'blue-ec2-ssh'
          def sshUser     = (!greenOff && isGreenBranch) ? 'ubuntu'     : 'ec2-user'
          def composeFile = (!greenOff && isGreenBranch)
                            ? '/opt/green/docker-compose.green.yml'
                            : '/opt/blue/docker-compose.blue.yml'

      /* â–¼ í™˜ê²½íŒŒì¼ ë™ê¸°í™” ë¸”ë¡ ì¶”ê°€ â–¼ */
      configFileProvider([configFile(fileId: 'blue-env', variable: 'ENV_FILE')]) {
        sshagent([sshCred]) {
          sh """
            scp -o StrictHostKeyChecking=no \$ENV_FILE ${sshUser}@${targetIP}:/opt/blue/blue.env
            ssh -o StrictHostKeyChecking=no ${sshUser}@${targetIP} <<'EOF'
              aws ecr get-login-password --region ${AWS_REGION} | \
                  docker login --username AWS --password-stdin ${ECR_URI}

              docker pull ${ECR_URI}/${APP_NAME}:${TAG}
              docker compose -f ${composeFile} up -d
            EOF
          """
          }
        }
      }
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ LB íŠ¸ë˜í”½ ìŠ¤ìœ„ì¹˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    stage('Switch Traffic') {
      when {
        allOf {
          not { environment name: 'GREEN_DISABLED', value: 'true' }   // Green ì‚´ì•„ìˆì„ ë•Œë§Œ
          anyOf { branch 'develop-be'; branch 'main' }
        }
      }
      steps {
        script {
          def isGreenBranch = (env.BRANCH_NAME == 'develop-be')
          def fromIP  = isGreenBranch ? env.BLUE_IP  : env.GREEN_IP
          def toIP    = isGreenBranch ? env.GREEN_IP : env.BLUE_IP

          sshagent(['lb-ssh']) {
            sh """
ssh -o StrictHostKeyChecking=no ec2-user@${LB_IP} <<'EOF'
  sudo sed -i 's/${fromIP}/${toIP}/' /etc/nginx/conf.d/loadbalancer.conf
  sudo nginx -s reload
EOF
            """
          }
        }
      }
    }
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ê²°ê³¼ ì•Œë¦¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  post {
    success { echo "âœ…  ${env.BRANCH_NAME} ë°°í¬ ì™„ë£Œ (TAG=${env.TAG})" }
    failure { echo "âŒ  ${env.BRANCH_NAME} ë°°í¬ ì‹¤íŒ¨ â€“ ì½˜ì†” ë¡œê·¸ í™•ì¸" }
  }
}
